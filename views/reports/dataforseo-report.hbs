<div class="card">
    <div class="card-body">
        <h2 class="card-title mb-4">DataForSEO Tool</h2>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search Parameters</h5>
            </div>
            <div class="card-body">
                <form id="serpForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Keyword</label>
                            <input type="text" class="form-control" id="keyword" required 
                                   placeholder="Enter keyword (max 700 chars)">
                            <div class="form-text">You can use special parameters like 'site:', 'inurl:', etc.</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Language Code</label>
                            <input type="text" class="form-control" id="languageCode" value="en">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Location Code</label>
                            <input type="number" class="form-control" id="locationCode" value="2840">
                            <div class="form-text">2840 = United States</div>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label class="form-label">Device</label>
                            <select class="form-select" id="device">
                                <option value="desktop">Desktop</option>
                                <option value="mobile">Mobile</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">OS</label>
                            <select class="form-select" id="os">
                                <option value="windows">Windows</option>
                                <option value="macos">MacOS</option>
                                <option value="android">Android</option>
                                <option value="ios">iOS</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Depth</label>
                            <input type="number" class="form-control" id="depth" value="100" min="1" max="700">
                            <div class="form-text">Max results (1-700)</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="priority">
                                <option value="1">Normal</option>
                                <option value="2">High</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            Search
                        </button>
                    </div>
                </form>

                <div id="results" class="mt-4" style="display: none;">
                    <h5>Search Results</h5>
                    <div class="table-responsive">
                        <table class="table table-sm" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Type</th>
                                    <th>Title</th>
                                    <th>URL</th>
                                    <th>Domain</th>
                                    <th>SERP Features</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border loading-spinner text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

{{#section 'scripts'}}
<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-spinner {
        width: 4rem;
        height: 4rem;
    }
</style>
<script>
    $(document).ready(function() {
        // Update OS options based on device selection
        $('#device').change(function() {
            const device = $(this).val();
            const $os = $('#os');
            $os.empty();
            
            if (device === 'desktop') {
                $os.append(new Option('Windows', 'windows'));
                $os.append(new Option('MacOS', 'macos'));
            } else {
                $os.append(new Option('Android', 'android'));
                $os.append(new Option('iOS', 'ios'));
            }
        });

        $('#serpForm').submit(function(e) {
            e.preventDefault();
            
            const formData = {
                keyword: $('#keyword').val().trim(),
                language_code: $('#languageCode').val(),
                location_code: parseInt($('#locationCode').val()),
                device: $('#device').val(),
                os: $('#os').val(),
                depth: parseInt($('#depth').val()),
                priority: parseInt($('#priority').val()),
                tag: 'google_organic'
            };

            if (!formData.keyword) {
                alert('Please enter a keyword');
                return;
            }

            $('#loadingOverlay').show();
            
            $.ajax({
                url: '/api/dataforseo/serp',
                method: 'POST',
                data: JSON.stringify({ task: formData }),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        displayResults(response.data);
                    } else {
                        alert(response.error?.message || response.error || 'Error getting results');
                    }
                },
                error: function(error) {
                    console.error('Error:', error);
                    const errorMessage = error.responseJSON?.error || error.statusText || 'Error analyzing keyword';
                    alert(errorMessage);
                },
                complete: function() {
                    $('#loadingOverlay').hide();
                }
            });
        });

        function displayResults(data) {
            $('#results').show();
            
            // Destroy existing DataTable if it exists
            if ($.fn.DataTable.isDataTable('#resultsTable')) {
                $('#resultsTable').DataTable().destroy();
            }
            
            // Clear the table body
            $('#resultsTableBody').empty();
            
            if (!Array.isArray(data) || data.length === 0) {
                $('#resultsTableBody').html('<tr><td colspan="6" class="text-center">No results found</td></tr>');
                return;
            }
            
            const tableHtml = data.map(item => `
                <tr>
                    <td>${item.rank_group || item.rank_position || '-'}</td>
                    <td>${item.type || '-'}</td>
                    <td>${item.title || '-'}</td>
                    <td>
                        <a href="${item.url || '#'}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;">
                            ${item.url || '-'}
                        </a>
                    </td>
                    <td>${item.domain || '-'}</td>
                    <td>${Array.isArray(item.serp_features) ? item.serp_features.join(', ') : '-'}</td>
                </tr>
            `).join('');
            
            $('#resultsTableBody').html(tableHtml);

            $('#resultsTable').DataTable({
                pageLength: 25,
                order: [[0, 'asc']],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip'
            });
        }
    });
</script>
{{/section}} 